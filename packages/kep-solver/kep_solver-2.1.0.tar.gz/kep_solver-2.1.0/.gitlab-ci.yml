image: python:3.9

include:
    - template: Code-Quality.gitlab-ci.yml

stages:
    - test
    - deploy

black:
    stage: test
    before_script:
        - pip install -e .[test]
    script:
        - black --check --diff kep_solver tests

mypy:
    stage: test
    before_script:
        - pip install -e .[test]
    script:
        - mypy

pytest:
    stage: test
    before_script:
        - pip install -e .[test]
    script:
        - pytest --cov=kep_solver
        - coverage xml
    artifacts:
      reports:
        coverage_report:
          coverage_format: cobertura
          path: coverage.xml

release:
    stage: deploy
    rules:
      - if: '$CI_COMMIT_TAG =~ /^v?[0-9]+(?:\.[0-9]+){2}$/'
    script:
      - pip uninstall kep_solver -y
      - pip install -U twine setuptools_scm
      - python setup.py sdist bdist_wheel
      - twine check dist/*
      - twine upload --repository-url https://upload.pypi.org/legacy/ dist/*

