AWSTemplateFormatVersion: '2010-09-09'
Description: S3 host bucket for {{appName}} in the {{envName}} environment, {{clusterName}} cluster.
Resources:
  Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketName: {{bucketName}}
      WebsiteConfiguration:
        IndexDocument: 'index.html'
        ErrorDocument: 'index.html'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: 'true'
        BlockPublicPolicy: 'true'
        IgnorePublicAcls: 'true'
        RestrictPublicBuckets: 'true'
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
    DeletionPolicy: Retain
  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: {{bucketName}}
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          Sid: Access-to-specific-VPCE-only
          Effect: Allow
          Principal: "*"
          Action: s3:GetObject
          Resource: !Join
            - ''
            - - !GetAtt Bucket.Arn
              - '/*'
          Condition:
            StringEquals:
              'aws:sourceVpce':
                - {{vpceId}}

Outputs:
  BucketPolicy:
    Value: !Ref BucketPolicy
    Description: Bucket policy giving access to the {{clusterName}}-vpc endpoint.
  Bucket:
    Value: !Ref Bucket
  DomainName:
    Value: !GetAtt Bucket.DomainName
    Export:
      Name: {{appName}}-{{envName}}-domain-name
  FrontendS3URL:
    Value: !GetAtt [Bucket, WebsiteURL]
    Description: URL for static site hosted on S3
    Export:
      Name: {{appName}}-{{envName}}-s3-url
