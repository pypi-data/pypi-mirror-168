"use strict";(self.webpackChunkoira_prototype=self.webpackChunkoira_prototype||[]).push([[307,7236],{48644:function(t,e,a){a.d(e,{y:function(){return c},z:function(){return l}});var i=a(87657),n=a(52896),o=a(538),r=a(26798);let s=null;async function c({url:t,editor:e,instance:a=null,pattern:c=null,extra_class:d=null}){const u=s,p=s=e.state.doc.nodeAt(e.state.selection.from);if(null!==a&&p!==u&&(a=l({instance:a,pattern_name:c.name})),a)a.get_content(t);else{c&&(i.Z.patterns[c.name]=c);const s=e.options.element;a=await new o.Z(s,{source:"ajax",url:t,trigger:"none",class:d,"position-list":["tl"]}),await n.Z.await_pattern_init(a);const l=(0,r.posToDOMRect)(e.view,e.state.selection.from,e.state.selection.to);a.tippy?.setProps({getReferenceClientRect:()=>l}),a.show()}return a}function l({instance:t,pattern_name:e}){return t&&(t.hide(),t.destroy(),t=null),e&&delete i.Z.patterns[e],null}},50307:function(t,e,a){a.r(e),a.d(e,{factory:function(){return g}});var i=a(26798),n=a(76922),o=a(98780);const r=new n.H$("suggestion");function s({pluginKey:t=r,editor:e,char:a="@",allowSpaces:s=!1,prefixSpace:c=!0,startOfLine:l=!1,decorationTag:d="span",decorationClass:u="suggestion",command:p=(()=>null),items:v=(()=>[]),render:m=(()=>({})),allow:h=(()=>!0)}){let g;const f=null==m?void 0:m();return new n.Sy({key:t,view(){return{update:async(t,a)=>{var i,n,o,r,s;const c=null===(i=this.key)||void 0===i?void 0:i.getState(a),l=null===(n=this.key)||void 0===n?void 0:n.getState(t.state),d=c.active&&l.active&&c.range.from!==l.range.from,u=!c.active&&l.active,m=c.active&&!l.active,h=u||d,y=!u&&!m&&c.query!==l.query&&!d,w=m||d;if(!h&&!y&&!w)return;const x=w&&!h?c:l,b=document.querySelector(`[data-decoration-id="${x.decorationId}"]`);g={editor:e,range:x.range,query:x.query,text:x.text,items:y||h?await v({editor:e,query:x.query}):[],command:t=>{p({editor:e,range:x.range,props:t})},decorationNode:b,clientRect:b?()=>{var t;const{decorationId:a}=null===(t=this.key)||void 0===t?void 0:t.getState(e.state);return document.querySelector(`[data-decoration-id="${a}"]`).getBoundingClientRect()}:null},w&&(null===(o=null==f?void 0:f.onExit)||void 0===o||o.call(f,g)),y&&(null===(r=null==f?void 0:f.onUpdate)||void 0===r||r.call(f,g)),h&&(null===(s=null==f?void 0:f.onStart)||void 0===s||s.call(f,g))},destroy:()=>{var t;g&&(null===(t=null==f?void 0:f.onExit)||void 0===t||t.call(f,g))}}},state:{init:()=>({active:!1,range:{},query:null,text:null,composing:!1}),apply(t,n,o,r){const{composing:d}=e.view,{selection:u}=t,{empty:p,from:v}=u,m={...n};if(m.composing=d,p||e.view.composing){!(v<n.range.from||v>n.range.to)||d||n.composing||(m.active=!1);const t=function(t){const{char:e,allowSpaces:a,prefixSpace:n,startOfLine:o,$position:r}=t,s=(0,i.escapeForRegEx)(e),c=new RegExp(`\\s${s}$`),l=o?"^":"",d=a?new RegExp(`${l}${s}.*?(?=\\s${s}|$)`,"gm"):new RegExp(`${l}(?:^)?${s}[^\\s${s}]*`,"gm"),u=r.depth<=0?0:r.before(),p=r.pos,v=r.doc.textBetween(u,p,"\0","\0"),m=Array.from(v.matchAll(d)).pop();if(!m||void 0===m.input||void 0===m.index)return null;const h=m.input.slice(Math.max(0,m.index-1),m.index),g=/^[\s\0]?$/.test(h);if(n&&!g)return null;const f=m.index+r.start();let y=f+m[0].length;return a&&c.test(v.slice(y-1,y+1))&&(m[0]+=" ",y+=1),f<r.pos&&y>=r.pos?{range:{from:f,to:y},query:m[0].slice(e.length),text:m[0]}:null}({char:a,allowSpaces:s,prefixSpace:c,startOfLine:l,$position:u.$from}),o=`id_${Math.floor(4294967295*Math.random())}`;t&&h({editor:e,state:r,range:t.range})?(m.active=!0,m.decorationId=n.decorationId?n.decorationId:o,m.range=t.range,m.query=t.query,m.text=t.text):m.active=!1}else m.active=!1;return m.active||(m.decorationId=null,m.range={},m.query=null,m.text=null),m}},props:{handleKeyDown(t,e){var a;const{active:i,range:n}=this.getState(t.state);return i&&(null===(a=null==f?void 0:f.onKeyDown)||void 0===a?void 0:a.call(f,{view:t,event:e,range:n}))||!1},decorations(t){const{active:e,range:a,decorationId:i}=this.getState(t);return e?o.EH.create(t.doc,[o.p.inline(a.from,a.to,{nodeName:d,class:u,"data-decoration-id":i})]):null}}})}var c=a(48644),l=a(37236),d=a(54593),u=a(52896),p=a(19513);var v=["aria-activedescendant","aria-atomic","aria-autocomplete","aria-busy","aria-checked","aria-controls","aria-describedby","aria-disabled","aria-dropeffect","aria-expanded","aria-flowto","aria-grabbed","aria-haspopup","aria-hidden","aria-invalid","aria-label","aria-labelledby","aria-level","aria-live","aria-multiline","aria-multiselectable","aria-orientation","aria-owns","aria-posinset","aria-pressed","aria-readonly","aria-relevant","aria-required","aria-selected","aria-setsize","aria-sort","aria-valuemax","aria-valuemin","aria-valuenow","aria-valuetext","role"];let m;function h(t,e){return{name:"tiptap-suggestion",trigger:".tiptap-items",async init(t){(0,l.focus_handler)(t[0]),this.el=t[0],this.active=this.items[0],u.Z.add_event_listener(this.el,"keydown","tiptap-suggestion-keydown",(t=>{if(t.preventDefault(),t.stopPropagation(),"ArrowDown"===t.code)if(this.active){let t=this.active?this.items.indexOf(this.active)+1:0;t>=this.items.length&&(t=0),this.active=this.items[t]}else this.active=this.items[0];else if("ArrowUp"===t.code)if(this.active){let t=this.active?this.items.indexOf(this.active)-1:0;t<0&&(t=this.items.length-1),this.active=this.items[t]}else this.active=this.items[0];else if("Enter"===t.code){const t=this.active?.dataset?.tiptapValue;if(!t)return;const e=this.active.querySelector("a");this.command(e,t)}})),u.Z.add_event_listener(this.el,"click","tiptap-suggestion-click",(t=>{const e=t.target.closest("a"),a=d.Z.acquire_attribute(e,"data-tiptap-value");a&&(t.preventDefault(),this.command(e,a))}))},command(t,a){const i=Object.fromEntries([...t.attributes].map((t=>[t.name,t.value])));e.command({"data-title":a,...i})},get active(){return this.el.querySelector(".tiptap-item.active")},set active(t){t&&(this.active?.classList.remove("active"),t.classList.add("active"))},get items(){return[...this.el.querySelectorAll(".tiptap-item")]}}}const g=({app:t,name:e,char:a,plural:o})=>i.Node.create({name:e,group:"inline",inline:!0,selectable:!1,atom:!0,addOptions:()=>({HTMLAttributes:{},url:null,renderLabel:({options:t,node:e})=>`${t.suggestion.char}${e.attrs["data-title"]}`,suggestion:{char:a,pluginKey:new n.H$(e)}}),addAttributes(){const t={class:{},href:{},target:{},title:{},"data-id":{},"data-title":{},"data-pat-inject":{},"data-pat-forward":{},"data-pat-modal":{},"data-pat-switch":{},"data-pat-toggle":{},"data-pat-tooltip":{}};t[`data-${this.name}`]={default:""};for(const e of v)t[e]={};return t},parseHTML(){return[{tag:`a[data-${this.name}]`}]},renderHTML({node:t,HTMLAttributes:e}){return["a",(0,i.mergeAttributes)(this.options.HTMLAttributes,e),this.options.renderLabel({options:this.options,node:t})]},renderText({node:t}){return this.options.renderLabel({options:this.options,node:t})},addKeyboardShortcuts(){return{Enter:()=>!!m&&(m.tippy?.popper?.querySelector(".tiptap-items")?.dispatchEvent(new KeyboardEvent("keydown",{code:"Enter"})),!0),Backspace:({editor:t})=>t.commands.command((({tr:t,state:e})=>{let a=!1;const{selection:i}=e,{empty:n,anchor:o}=i;return!!n&&(e.doc.nodesBetween(o-1,o,((e,i)=>{if(e.type.name===this.name)return a=!0,t.insertText(this.options.suggestion.char||"",i,i+e.nodeSize),!1})),a)}))}},addProseMirrorPlugins(){return this.options.suggestion.command=({editor:t,range:e,props:a})=>{e.to=t.state.selection.$head.pos,t.chain().focus().insertContentAt(e,[{type:this.name,attrs:a},{type:"text",text:" "}]).run()},this.options.suggestion.render=()=>{let t;return{onStart:async e=>{const a=async({transaction:t}={transaction:null})=>{let a=this.options.url,i=e.range.from+1,n=t?t.curSelection.$head.pos:e.range.to;const r=this.editor.state.doc.textBetween(i,n,"");return a=r?a+r:a,await(0,c.y)({url:a,editor:this.editor,instance:m,pattern:h(0,e),extra_class:`tiptap-${o||this.name}`})};t=p.Z.debounce((async t=>{m=await a(t)}),200),m=await a(),this.editor.on("selectionUpdate",t)},onKeyDown:e=>{if(m){if("Escape"===e.event.key)return m=(0,c.z)({instance:m,pattern_name:"tiptap-suggestion"}),this.editor.off("selectionUpdate",t),!0;if("ArrowDown"===e.event.key||"ArrowUp"===e.event.key||"Enter"===e.event.key){e.event.preventDefault(),e.event.stopPropagation();const t=document.querySelector(".tiptap-items");if(!t)return;t.dispatchEvent(new KeyboardEvent("keydown",{code:e.event.key}))}}},onExit:()=>{m=(0,c.z)({instance:m,pattern_name:"tiptap-suggestion"}),this.editor.off("selectionUpdate",t)}}},this.options.suggestion.allow=({state:t,range:e})=>{const a=t.doc.resolve(e.from),i=t.schema.nodes[this.name];return!!a.parent.type.contentMatch.matchType(i)},[s({editor:this.editor,...this.options.suggestion})]}})},37236:function(t,e,a){a.r(e),a.d(e,{TARGETS:function(){return o},focus_handler:function(){return r}});var i=a(52896),n=a(19513);const o=[];function r(t){t.setAttribute("tabindex","-1"),i.Z.add_event_listener(t,"focus","tiptap-focusin",(async()=>{n.Z.timeout(1),o.map((t=>t?.classList.add("tiptap-focus")))}),!0),i.Z.add_event_listener(t,"blur","tiptap-focusout",(()=>{o.map((t=>t?.classList.remove("tiptap-focus")))}),!0)}}}]);
//# sourceMappingURL=307.44aa1ea78a93f893c723.min.js.map